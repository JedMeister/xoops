#!/bin/sh -ex

DB_NAME=xoops
DB_USER=xoops
DB_PREFIX=xoops
DB_PASS=$(mcookie)

ADMIN_NAME=admin
ADMIN_PASS=turnkey
ADMIN_MAIL=admin@example.com

SRC=/usr/local/src
WEBROOT=/var/www/xoops
XOOPS=/var/local/lib/xoops

# unpack and configure
tar -zxf $SRC/xoops-*.tar.gz -C $SRC
cp -a $SRC/xoops-*/htdocs $WEBROOT
cp -TdR $SRC/xoops-*/extras/modules $WEBROOT/modules
cp $SRC/xoops-*/extras/mainfile.php $WEBROOT
rm -rf $SRC/xoops-*
chown -R root:root $WEBROOT
chown -R www-data:www-data $WEBROOT/uploads
chown www-data:www-data $WEBROOT/mainfile.php
chown www-data:www-data $WEBROOT/include/license.php

mkdir -p $XOOPS
mv $WEBROOT/xoops_lib $XOOPS/lib
mv $WEBROOT/xoops_data $XOOPS/data
chown -R www-data:www-data $XOOPS/data/caches
chown -R www-data:www-data $XOOPS/data/data
chown -R www-data:www-data $XOOPS/lib/modules/protector/configs/

# configure apache
a2dissite default
a2ensite xoops
a2enmod rewrite

# start services
/etc/init.d/mysql start
/etc/init.d/apache2 start

# setup the database
MYSQL_BATCH="mysql --user=root --password=$MYSQL_PASS --batch"
MYSQL_ADMIN="mysqladmin --user=root --password=$MYSQL_PASS"

$MYSQL_ADMIN create $DB_NAME
$MYSQL_BATCH --execute "grant all privileges on $DB_NAME.* to $DB_USER@localhost identified by '$DB_PASS'; flush privileges;"

# curl based install
XMAIL=$(echo $ADMIN_MAIL | sed s/@/%40/)
XROOT=$(echo $WEBROOT | sed "s/\//%2F/g")
XDATA=$(echo $XOOPS/data | sed "s/\//%2F/g")
XLIB=$(echo $XOOPS/lib | sed "s/\//%2F/g")

URL="http://127.0.0.1/install"
CURL="curl -c /tmp/cookie -b /tmp/cookie"

$CURL ${URL}/index.php --data "xo_install_lang=english"
$CURL ${URL}/page_start.php
$CURL ${URL}/page_pathsettings.php --data "root=$XROOT&data=$XDATA&lib=$XLIB&URL=http%3A%2F%2F127.0.0.1"
$CURL ${URL}/page_dbconnection.php --data "DB_TYPE=mysql&DB_HOST=localhost&DB_USER=$DB_USER&DB_PASS=$DB_PASS"
$CURL ${URL}/page_dbsettings.php --data "DB_NAME=$DB_NAME&DB_PREFIX=$DB_PREFIX&DB_CHARSET=utf8&DB_COLLATION=utf8_general_ci"
$CURL ${URL}/page_configsave.php
$CURL ${URL}/page_tablescreate.php
$CURL ${URL}/page_siteinit.php --data "adminname=$ADMIN_NAME&adminmail=$XMAIL&adminpass=$ADMIN_PASS&adminpass2=$ADMIN_PASS&generated_pw="
$CURL ${URL}/page_tablesfill.php
$CURL ${URL}/page_configsite.php --data "sitename=TurnKey+Xoops&slogan=&conf_ids%5B%5D=1&conf_ids%5B%5D=2&meta_keywords=xoops%2C+web+applications%2C+web+2.0%2C+sns%2C+news%2C+technology%2C+headlines%2C+linux%2C+software%2C+download%2C+downloads%2C+free%2C+community%2C+forum%2C+bulletin+board%2C+bbs%2C+php%2C+survey%2C+polls%2C+kernel%2C+comment%2C+comments%2C+portal%2C+odp%2C+open+source%2C+opensource%2C+FreeSoftware%2C+gnu%2C+gpl%2C+license%2C+Unix%2C+*nix%2C+mysql%2C+sql%2C+database%2C+databases%2C+web+site%2C+blog%2C+wiki%2C+module%2C+modules%2C+theme%2C+themes%2C+cms%2C+content+management&meta_description=XOOPS+is+a+dynamic+Object+Oriented+based+open+source+portal+script+written+in+PHP.&meta_author=XOOPS&meta_copyright=Copyright+%40+2001-2012&conf_ids%5B%5D=1&conf_ids%5B%5D=2&conf_ids%5B%5D=38&conf_ids%5B%5D=51&conf_ids%5B%5D=49&conf_ids%5B%5D=50&allow_register=1&conf_ids%5B%5D=1&conf_ids%5B%5D=2&conf_ids%5B%5D=38&conf_ids%5B%5D=51&conf_ids%5B%5D=49&conf_ids%5B%5D=50&conf_ids%5B%5D=56"
$CURL ${URL}/page_theme.php --data "theme_set=zetagenesis&conf_ids%5B%5D=7"
$CURL ${URL}/page_moduleinstaller.php --data "modules%5Bpm%5D=1&modules%5Bprofile%5D=1&modules%5Bprotector%5D=1"
$CURL ${URL}/page_end.php

rm -f /tmp/cookie
rm -rf $WEBROOT/install

# create welcome block
BLOCK_ID="13"
DATE="1339947200"
WELCOME='<p>Lets get you started...</p><ol><li>Log in as <b>admin</b> and visit the <a href=\"/admin.php\">administration dashboard</a> to customize your site.</li><li>When ready, delete this welcome block and create some new ones.</li></ol><p>For more information, check out the <a href=\"http://www.turnkeylinux.org/xoops\">release notes</a> and the <a href=\"http://xoops.org/modules\">online documentation</p>.'

$MYSQL_BATCH --database=$DB_NAME --execute "INSERT INTO ${DB_PREFIX}_newblocks VALUES ('$BLOCK_ID', '0', '0', '', 'Custom Block \(HTML\)', 'Welcome to TurnKey Xoops', '$WELCOME', '5', '0', '1', 'C', 'H', '1', '', '', '', '', '', '0', '$DATE');"

$MYSQL_BATCH --database=$DB_NAME --execute "INSERT INTO ${DB_PREFIX}_block_module_link VALUES ('$BLOCK_ID', '-1')"

$MYSQL_BATCH --database=$DB_NAME --execute "INSERT INTO ${DB_PREFIX}_group_permission VALUES ('', '1', '$BLOCK_ID', '1', 'block_read');"
$MYSQL_BATCH --database=$DB_NAME --execute "INSERT INTO ${DB_PREFIX}_group_permission VALUES ('', '2', '$BLOCK_ID', '1', 'block_read');"
$MYSQL_BATCH --database=$DB_NAME --execute "INSERT INTO ${DB_PREFIX}_group_permission VALUES ('', '3', '$BLOCK_ID', '1', 'block_read');"

# remove hardcoded IP
$MYSQL_BATCH --database=$DB_NAME --execute "UPDATE ${DB_PREFIX}_banner SET imageurl=\"/images/banners/xoops_flashbanner2.swf\" WHERE bid=\"1\";"
$MYSQL_BATCH --database=$DB_NAME --execute "UPDATE ${DB_PREFIX}_banner SET imageurl=\"/images/banners/xoops_banner_2.gif\" WHERE bid=\"2\";"
$MYSQL_BATCH --database=$DB_NAME --execute "UPDATE ${DB_PREFIX}_banner SET imageurl=\"/images/banners/banner.swf\" WHERE bid=\"3\";"

sed -i "s|XOOPS_URL.*|XOOPS_URL', '');|g" $WEBROOT/mainfile.php

# secure sensitive files
chmod 440 $WEBROOT/mainfile.php
chmod 440 $XOOPS/data/data/secure.php

# stop services
/etc/init.d/mysql stop
/etc/init.d/apache2 stop

